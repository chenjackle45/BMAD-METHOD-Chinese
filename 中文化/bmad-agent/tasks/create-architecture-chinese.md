# 架構建立任務

## 目的

- 根據專案需求（PRD、epics、brief）、研究發現和使用者輸入，設計一個完整、穩健且文件齊全的技術架構。
- 做出明確的技術選擇，並闡明其背後的基本原理，利用架構範本作為結構指南。
- 產出所有必要的技術產出物，確保架構經過最佳化，以便高效實作（尤其是由 AI 開發者代理程式執行），並根據 `architect-checklist` 進行驗證。

## 指示

1.  **輸入分析與對話建立：**

    - 確保您擁有所有必要的輸入：PRD 文件（特別檢查「技術假設」和「初始架構提示」部分，以了解已決定的 repository 和服務架構）、專案簡報、任何深度研究報告，以及可選的 `technical-preferences.md`。索取任何遺失的關鍵文件。
    - 徹底檢閱所有輸入。
    - 總結從輸入中衍生的關鍵技術需求、限制、NFRs (Non-Functional Requirements) 以及已決定的 repository/服務架構。將此摘要呈現給使用者以供確認，並確保雙方理解一致。
    - 根據輸入分享初步的架構觀察、潛在挑戰或需要釐清的領域。
      **建立架構建立的互動模式：**
      - 詢問使用者：「您希望如何著手建立此專案的架構？我們可以採用以下方式：
        A. **漸進式（預設且建議）：** 我們將逐步完成每個架構決策、文件章節或設計要點。我會提交草稿，並在進入下一部分之前尋求您的回饋和確認。這最適合複雜的決策和詳細的調整。
        B. **「YOLO」模式：** 我可以產出一個更全面的架構初始草稿（或重要部分），供您進行更廣泛的初步檢閱。然後我們可以根據您的回饋對特定部分進行迭代。這可以更快地產生初始想法，但如果偏好在每個步驟進行詳細協作，則通常不建議使用。」
      - 要求使用者選擇他們偏好的模式（例如，「請告訴我您偏好 A 或 B。」）。
      - 使用者選擇後，確認所選模式（例如，「好的，我們將以漸進模式進行。」）。此選定模式將決定此任務中後續步驟的執行方式。

2.  **解決模糊之處並收集遺失資訊：**

    - 如果在初步檢閱後仍遺失關鍵資訊或需求不清楚，請提出具體、有針對性的問題。
    - **外部 API 詳細資訊：** 如果專案涉及與外部 API 整合，特別是那些較不常見或您對其特定請求/回應 schema 的訓練資料信心不足的 API，並且如果未對這些 API 進行「深度研究」階段：
      - 主動要求使用者提供精確的詳細資訊。這包括：
        - 官方 API 文件連結。
        - 請求結構範例（例如，cURL 指令、JSON payloads）。
        - 回應結構範例（例如，典型情境的 JSON responses，包括錯誤回應）。
      - 解釋此資訊對於在架構中準確定義 API 互動合約、建立穩健的 facades/adapters 以及實現準確的技術規劃（例如，用於技術 stories 或 epic refinements）至關重要。
    - 向使用者提出問題（如果有多個問題，則按邏輯分批提出）並等待他們的輸入。
    - 在繼續之前，記錄所有收到的決定和釐清。

3.  **迭代技術選擇與設計（互動式，若非 YOLO 模式）：**

    - 對於每個主要的架構元件或決策點（例如，前端框架、後端語言/框架、資料庫系統、雲端供應商、關鍵服務、通訊模式）：
      - 如果根據需求或研究存在多個可行的選項，請提出 2-3 個選擇，簡要概述其優缺點以及與專案的相關性。在制定這些選項和您的建議時，請考慮 `technical-preferences.md` 中陳述的任何偏好。
      - 陳述您建議的選擇，並根據需求、研究發現、使用者偏好（如果已知）和最佳實務（例如，可擴展性、成本、團隊熟悉度、生態系統）提供明確的基本原理。
      - 在最終確定決策之前，徵求使用者回饋、解決疑慮並尋求明確批准。
      - 在架構文件中記錄已確認的選擇及其基本原理。
    - **入門範本：** 如果適用且有要求，研究並推薦合適的入門範本或評估現有的程式碼庫。解釋其與專案目標的一致性並尋求使用者確認。

4.  **建立技術產出物（漸進式，除非是 YOLO 模式，並以 `architecture-tmpl` 為指引）：**

    - 對於主要架構文件的每個產出物或章節：

      - **解釋目的：** 簡要描述產出物/章節的重要性及其涵蓋的內容。
      - **逐節草擬：** 一次提交一個邏輯區塊的草稿。
        - 確保「高階概觀」和「元件視圖」章節準確反映並詳細說明 PRD 中決定的 repository/服務架構。
        - 確保已記錄的編碼標準（無論是作為專用章節還是參考）和「測試策略」章節明確定義：
          - 單元測試檔案位置的慣例（例如，與原始檔放在一起，或放在單獨的資料夾中，如 `tests/` 或 `__tests__/`）。
          - 單元測試檔案的命名慣例（例如，`*.test.js`、`*.spec.ts`、`test_*.py`）。
        - 在討論編碼標準時，告知使用者這些標準將作為 AI 開發者代理程式的嚴格規則。強調這些標準應保持在最低必要程度，以防止代理程式產生不良或混亂的程式碼。引導使用者理解應避免過於規範或顯而易見的標準（例如，「使用 SOLID 原則」，訓練有素的 LLM 應該已經知道），因為使用者最了解他們將採用的特定代理程式和工具，因此最能判斷適當的細節程度。
      - **整合回饋：** 與使用者討論草稿，整合其回饋，並視需要進行迭代。
      - 提供進階反思與引導選項：
        <critical_rule>一旦重要架構文件章節（例如，「元件視圖」、「資料管理策略」、「安全性架構」）的草稿已建立，並且您（執行此任務的 AI 代理程式）已整合使用者對該特定草稿的初步回饋和修訂，您接著將向使用者呈現以下「進階反思、引導與腦力激盪行動」清單。解釋這些是選用步驟，有助於在繼續之前確保品質、探索替代方案並加深對目前草稿的理解。使用者可以透過數字選擇一個行動，或選擇跳過此步驟並繼續。</critical_rule>

        「我們已經完善了目前架構章節的草稿：[特定架構章節/元件]。為確保其穩健性、探索替代方案並考量所有角度，我可以執行以下其中一項行動。請選擇一個數字，或者如果您準備好繼續，請告訴我：

        **我可以採取的進階反思、引導與腦力激盪行動：**

        {Instruction for AI Agent: Just display the title of each numbered item below. If the user asks what a specific option means, provide a brief explanation of the action you will take, drawing from detailed descriptions outlined for an Architect's context.}

        1.  **批判性自我檢閱與需求對齊**
        2.  **產生並評估替代架構方法**
        3.  **韌性、可擴展性與效能壓力測試（概念性）**
        4.  **深入探討技術假設、限制與相依性**
        5.  **安全性與風險評估檢閱與探究性問題**
        6.  **協作設計腦力激盪與模式探索**
        7.  **引導「未預見的影響」與未來驗證問題**
        8.  **繼續進行下一個[架構章節/任務]。**

        在我執行所選行動後，我們可以討論結果並決定任何進一步的修訂。
        當您對此章節的目前草稿感到滿意時，我們可以接著直接進行[下一個邏輯步驟，例如，「下一個架構元件」，或者如果所有章節都已草擬完成，則為「步驟 5：識別遺失的技術 Stories / 調整 Epics」或「步驟 6：根據檢查清單驗證架構並完成輸出」。]」

      - **尋求批准：** 在進入下一節之前，或對於整體草擬的整個產出物（在 YOLO 模式下），獲得使用者對該節的明確批准。

5.  **識別遺失的技術 Stories / 調整 Epics（互動式）：**

    - 根據設計的架構，識別任何尚未在 PRD 或 epics 中記錄的必要技術 stories/任務（例如，「為前端部署設定 CI/CD pipeline」、「使用 JWT 實作驗證模組」、「為後端服務建立基礎 Docker images」、「根據資料模型設定初始資料庫 schema」）。
    - 解釋這些技術 stories 對於實現功能需求和成功執行專案的重要性。
    - 與使用者協作以調整這些 stories（清晰的描述、驗收標準），並建議將其新增至專案 backlog 或相關的 epics。
    - 檢閱 PRD 中的現有 epics/stories，並建議技術考量或驗收標準調整，以確保它們可以根據所選架構實作。例如，指定要呼叫的 API 端點、資料格式或關鍵函式庫版本。
    - 協作後，準備一份簡潔的摘要，詳細說明對 epics 和 user stories 的所有建議新增、更新或修改。如果未識別任何變更，則明確說明。

6.  **根據檢查清單驗證架構並完成輸出：**
    - 主要架構文件元件草擬並與使用者檢閱完畢後，使用 `architect-checklist` 進行全面檢閱。
    - 逐項檢查清單，確保架構文件全面，解決所有關鍵架構問題（例如，安全性、可擴展性、可維護性、可測試性（包括確認編碼標準和測試策略明確定義單元測試位置和命名慣例）、開發者體驗），並且建議的解決方案穩健。
    - 對於每個檢查清單項目，確認其狀態（例如，[x] 已完成，[ ] 不適用，[!] 需要注意）。
    - 如果根據檢查清單發現缺陷、差距或需要更詳細說明或釐清的領域：
      - 與使用者討論這些發現。
      - 協作進行必要的更新、新增或調整架構文件以解決這些問題。
    - 在解決所有檢查清單要點並確保架構文件穩健且完整後，向使用者提交檢查清單檢閱摘要。此摘要應強調：
      - 確認架構已滿足檢查清單的所有相關章節/項目。
      - 任何標記為不適用的項目，並附上簡要理由。
      - 關於因檢查清單檢閱而對架構文件進行的任何重要討論、決定或變更的簡要說明。
    - **提供 Design Architect 提示（若適用）：**
      - 如果架構包含 UI 元件，詢問使用者是否希望在主要架構文件末尾加入一個專門給「Design Architect」的提示。
      - 解釋此提示可以記錄特定的 UI 考量、討論筆記或不適合放在核心技術架構文件中但對 Design Architect 至關重要的決定。
      - 該提示還應說明 Design Architect 隨後將在其專門模式下運作以定義詳細的前端架構。
      - 如果使用者同意，協作草擬此提示並將其附加到架構文件中。
    - 取得使用者對完整架構文件產生的最終批准。
    - **建議 UI 的後續步驟（若適用）：**
      - 主要架構文件定稿並獲批准後：
      - 如果專案涉及使用者介面（從輸入的 PRD 以及可能提及 UI 元件或參考 Design Architect 的 UI/UX 規格階段輸出的架構文件中應可明顯看出）：
        - 強烈建議使用者，UI 的下一個關鍵步驟是讓 **Design Architect** 代理程式參與。
        - 具體而言，建議他們使用 Design Architect 的 **「前端架構模式」**。
        - 解釋 Design Architect 將使用現已完成的主要架構文件和詳細的 UI/UX 規格（例如，`front-end-spec-tmpl.txt` 或充實的 PRD）作為主要輸入，以定義特定的前端架構、選擇前端函式庫/框架（如果尚未決定）、建構前端元件並詳細說明互動模式。

### 架構建立階段的輸出交付成果

- 一份全面的架構文件，根據 `architecture-tmpl`（全為 markdown 格式）或雙方同意的格式建構，包含上述所有章節。
- 清晰的 Mermaid 圖表，用於架構概觀、資料模型等。
- 一份新的或調整過的技術 user stories/任務清單，可供整合至 backlog。
- 一份關於現有 epics 或 user stories 所需任何已識別變更（新增、更新、修改）的摘要，或者如果不需要此類變更，則明確確認。
- 一份已完成的 `architect-checklist`（或其驗證摘要）。
- 可選地，如果涉及 UI 元件且使用者同意：在主要架構文件末尾附加一個給「Design Architect」的提示，總結相關的 UI 考量並概述 Design Architect 的後續步驟。
