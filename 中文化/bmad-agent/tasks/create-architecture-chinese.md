# 架構建立任務

## 目的

- 根據專案需求（PRD、epics、簡報）、研究發現和使用者輸入，設計一個完整、穩健且文件齊全的技術架構。
- 做出明確的技術選擇，並闡明其背後的理由，利用架構範本作為結構指南。
- 產出所有必要的技術產出物，確保架構經過優化以實現高效實施（尤其針對 AI 開發者代理程式），並根據 `architect-checklist` 進行驗證。

## 指示

1.  **輸入分析與對話建立：**

    - 確保您擁有所有必要的輸入：PRD 文件（特別檢查「技術假設」和「初始架構提示」部分，以了解已決定的儲存庫和服務架構）、專案簡報、任何深度研究報告，以及可選的 `technical-preferences.md`。若缺少任何關鍵文件，請提出要求。
    - 徹底檢閱所有輸入。
    - 總結從輸入中得出的關鍵技術需求、限制、NFR（非功能性需求）以及已決定的儲存庫/服務架構。將此摘要呈現給使用者以供確認，並確保雙方理解一致。
    - 分享基於輸入的初步架構觀察、潛在挑戰或需要釐清的領域。
      **建立架構建立的互動模式：**
      - 詢問使用者：「您希望如何進行此專案的架構建立？我們可以採用以下方式：
        A. **漸進式（預設且建議）：** 我們將逐步完成每個架構決策、文件章節或設計要點。我會呈現草稿，並在進入下一部分之前尋求您的回饋和確認。這最適合複雜的決策和詳細的調整。
        B. **「YOLO」模式：** 我可以先產出一個更全面的架構（或重要部分）的初始草稿供您進行更廣泛的審查。然後我們可以根據您的回饋對特定部分進行迭代。這可以更快地產生初始想法，但如果偏好在每個步驟進行詳細協作，則通常不建議使用。」
      - 要求使用者選擇他們偏好的模式（例如，「請告訴我您偏好 A 或 B。」）。
      - 使用者選擇後，確認所選模式（例如，「好的，我們將以漸進模式進行。」）。此選定模式將決定此任務中後續步驟的執行方式。

2.  **解決模糊之處並收集缺失資訊：**

    - 如果在初步檢閱後仍缺少關鍵資訊或需求不清楚，請提出具體、有針對性的問題。
    - **外部 API 詳細資訊：** 如果專案涉及與外部 API 整合，特別是那些較不常見或您對其特定請求/回應結構的訓練資料信心不足的 API，並且未對這些 API 進行「深度研究」階段：
      - 主動要求使用者提供精確的詳細資訊。這包括：
        - 官方 API 文件連結。
        - 請求結構範例（例如，cURL 指令、JSON 有效負載）。
        - 回應結構範例（例如，典型情境的 JSON 回應，包括錯誤回應）。
      - 解釋此資訊對於在架構中準確定義 API 互動合約、建立穩健的 facades/adapters 以及實現準確的技術規劃（例如，針對 technical stories 或 epic refinements）至關重要。
    - 向使用者提出問題（如果有多個問題，則進行邏輯分批），並等待他們的輸入。
    - 在繼續之前，記錄所有收到的決定和釐清。

3.  **迭代式技術選擇與設計（互動式，若非 YOLO 模式）：**

    - 對於每個主要架構元件或決策點（例如，前端框架、後端語言/框架、資料庫系統、雲端供應商、關鍵服務、通訊模式）：
      - 如果根據需求或研究存在多個可行選項，請呈現 2-3 個選擇，簡要概述其優缺點以及與專案的相關性。在制定這些選項和您的建議時，請考慮 `technical-preferences.md` 中陳述的任何偏好。
      - 陳述您建議的選擇，並根據需求、研究發現、使用者偏好（如果已知）和最佳實務（例如，可擴展性、成本、團隊熟悉度、生態系統）提供明確的理由。
      - 在最終確定決策之前，徵求使用者回饋、解決疑慮並尋求明確批准。
      - 在架構文件中記錄已確認的選擇及其理由。
    - **入門範本：** 如果適用且有要求，研究並推薦合適的入門範本或評估現有程式碼庫。解釋其與專案目標的一致性，並尋求使用者確認。

4.  **建立技術產出物（漸進式，除非是 YOLO 模式，並以 `architecture-tmpl` 為指南）：**

    - 對於主要架構文件的每個產出物或章節：

      - **解釋目的：** 簡要描述該產出物/章節的重要性及其將涵蓋的內容。
      - **逐節起草：** 一次呈現一個邏輯區塊的草稿。
        - 確保「高階概觀」和「元件視圖」章節準確反映並詳細說明 PRD 中決定的儲存庫/服務架構。
        - 確保文件化的編碼標準（作為專用章節或參考）和「測試策略」章節明確定義：
          - 單元測試檔案位置的慣例（例如，與原始檔案放在一起，或放在單獨的資料夾中，如 `tests/` 或 `__tests__/`）。
          - 單元測試檔案的命名慣例（例如，`*.test.js`、`*.spec.ts`、`test_*.py`）。
        - 在討論編碼標準時，告知使用者這些將作為 AI 開發者代理程式的嚴格規則。強調這些標準應保持在最低必要程度，以防止代理程式產生不良或混亂的程式碼。引導使用者理解應避免過於規範或顯而易見的標準（例如，「使用 SOLID 原則」，訓練有素的 LLM 應該已經知道），因為使用者了解他們將採用的特定代理程式和工具，最能判斷適當的詳細程度。
        - **整合回饋：** 與使用者討論草稿，整合他們的回饋，並根據需要進行迭代。
        - [提供進階自我完善與引出選項](#offer-advanced-self-refinement--elicitation-options)
        - **尋求批准：** 在進入下一節之前，或對於整體起草的整個產出物（在 YOLO 模式下），獲得使用者對該節的明確批准。

5.  **識別缺失的 Technical Stories / 優化 Epics（互動式）：**

    - 根據設計的架構，識別任何尚未在 PRD 或 epics 中捕獲的必要 technical stories/tasks（例如，「為前端部署設定 CI/CD 管線」、「使用 JWT 實作驗證模組」、「為後端服務建立基礎 Docker 映像檔」、「根據資料模型設定初始資料庫結構」）。
    - 解釋這些 technical stories 對於實現功能需求和成功執行專案的重要性。
    - 與使用者協作以優化這些 stories（清晰的描述、驗收標準），並建議將它們添加到專案 backlog 或相關的 epics 中。
    - 檢閱 PRD 中的現有 epics/stories，並建議技術考量或驗收標準的優化，以確保它們可以根據所選架構實作。例如，指定要呼叫的 API 端點、資料格式或關鍵函式庫版本。
    - 協作後，準備一份簡明摘要，詳細說明對 epics 和 user stories 的所有建議新增、更新或修改。如果未識別任何變更，則明確說明。

6.  **根據檢查清單驗證架構並完成輸出：**
    - 主要架構文件元件起草並與使用者檢閱完畢後，使用 `architect-checklist` 進行全面檢閱。
    - 逐項檢查清單，確保架構文件全面，解決所有關鍵架構問題（例如，安全性、可擴展性、可維護性、可測試性（包括確認編碼標準和測試策略明確定義單元測試位置和命名慣例）、開發者體驗），並且建議的解決方案穩健。
    - 對於每個檢查清單項目，確認其狀態（例如，\[x] 已完成，\[ ] 不適用，\[!] 需要注意）。
    - 如果根據檢查清單發現缺陷、差距或需要更詳細說明或釐清的領域：
      - 與使用者討論這些發現。
      - 協作進行必要的更新、新增或優化，以解決這些問題。
    - 在解決所有檢查清單要點並確保架構文件穩健且完整後，向使用者呈現檢查清單檢閱的摘要。此摘要應強調：
      - 確認檢查清單的所有相關章節/項目均已由架構滿足。
      - 任何標記為不適用的項目，並附上簡要理由。
      - 關於因檢查清單檢閱而對架構文件進行的任何重要討論、決策或變更的簡要說明。
    - **提供設計架構師提示（若適用）：**
      - 如果架構包含 UI 元件，詢問使用者是否希望在主要架構文件末尾包含一個專門針對「設計架構師」的提示。
      - 解釋此提示可以記錄特定的 UI 考量、討論筆記或不適合核心技術架構文件但對設計架構師至關重要的決策。
      - 該提示還應說明設計架構師隨後將在其專門模式下運作以定義詳細的前端架構。
      - 如果使用者同意，協作起草此提示並將其附加到架構文件中。
    - 獲得使用者對完整架構文件產生的最終批准。
    - **建議 UI 的後續步驟（若適用）：**
      - 在主要架構文件最終確定並獲得批准後：
      - 如果專案涉及使用者介面（從輸入的 PRD 以及可能提及 UI 元件或參考設計架構師 UI/UX 規格階段輸出的架構文件中應可明顯看出）：
        - 強烈建議使用者，UI 的下一個關鍵步驟是讓 **設計架構師** 代理程式參與。
        - 具體而言，建議他們使用設計架構師的 **「前端架構模式」**。
        - 解釋設計架構師將使用現已完成的主要架構文件和詳細的 UI/UX 規格（例如，`front-end-spec-tmpl.txt` 或充實的 PRD）作為主要輸入，以定義特定的前端架構、選擇前端函式庫/框架（如果尚未決定）、建構前端元件並詳細說明互動模式。

### 架構建立階段的輸出交付成果

- 一份全面的架構文件，根據 `architecture-tmpl`（全部為 markdown 格式）或商定的格式建構，包括上述所有章節。
- 清晰的 Mermaid 圖表，用於架構概觀、資料模型等。
- 一份新的或優化過的 technical user stories/tasks 清單，可供整合至 backlog。
- 一份關於現有 epics 或 user stories 所需的任何已識別變更（新增、更新、修改）的摘要，或者如果不需要此類變更，則明確確認。
- 一份已完成的 `architect-checklist`（或其驗證摘要）。
- 可選地，如果涉及 UI 元件且使用者同意：附加到主要架構文件的一個「設計架構師」提示，總結相關的 UI 考量並概述設計架構師的後續步驟。

## 提供進階自我完善與引出選項

（此部分在需要時於此之前呼叫）

向使用者呈現以下「進階反思、引出與腦力激盪行動」清單。解釋這些是可選步驟，有助於確保品質、探索替代方案，並在最終確定當前章節並繼續之前加深對其的理解。使用者可以按編號選擇一個行動，或選擇跳過此步驟並繼續最終確定該章節。

「為確保當前章節的品質：**[特定章節名稱]** 並確保其穩健性、探索替代方案並考慮所有角度，我可以執行以下任何行動。請選擇一個編號（8 表示最終確定並繼續）：

**我可以採取的進階反思、引出與腦力激盪行動：**

{AI 代理程式指示：顯示以下每個編號項目的標題。如果使用者詢問特定選項的含義，請根據針對該情境量身打造的詳細描述，簡要解釋您將採取的行動。}

1.  **批判性自我檢閱與使用者目標一致性**
2.  **產生並評估替代設計解決方案**
3.  **使用者旅程與互動壓力測試（概念性）**
4.  **深入探討設計假設與限制**
5.  **可用性與無障礙稽核檢閱與探究性問題**
6.  **協作構思與 UI 功能腦力激盪**
7.  **引出「未預見的使用者需求」與未來互動問題**
8.  **最終確定此章節並繼續。**

在我執行所選行動後，我們可以討論結果並決定此章節的任何進一步修訂。」

重複詢問使用者是否希望執行另一個反思、引出與腦力激盪行動，直到使用者表示可以進入下一章節（或選擇 #8）。
